<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wikitexto</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f9f9fb;
      padding: 2em;
    }
    .correct {
      color: green;
      font-weight: bold;
    }
    #gameContent {
      display: none;
    }
    #loadingSpinnerWrapper {
      margin-top: 1em;
      text-align: center;
      display: none;
    }
    .autocomplete-container {
      position: relative;
    }
    .autocomplete-suggestions {
      position: absolute;
      top: 100%;
      z-index: 1000;
      width: 100%;
      background: white;
      border: 1px solid #ced4da;
      border-top: none;
      max-height: 150px;
      overflow-y: auto;
    }
    .autocomplete-suggestion {
      padding: 0.5em;
      cursor: pointer;
    }
    .autocomplete-suggestion:hover {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="my-4 text-primary">Wikitexto</h1>
    <p class="lead">Guess the hidden Wikidata item using a QID or a description sentence.</p>

    <div id="initialLoading" class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3">Loading game...</p>
    </div>

    <div id="gameContent">
      <div class="input-group mb-3 autocomplete-container">
        <input type="text" class="form-control" id="guessInput" placeholder="Enter QID or description" autocomplete="off" />
        <button class="btn btn-primary" type="button" id="guessBtn" onclick="submitGuess()">Guess</button>
        <div id="autocompleteList" class="autocomplete-suggestions"></div>
      </div>
      <div id="loadingSpinnerWrapper">
        <div class="spinner-border text-primary" id="loadingSpinner" role="status"></div>
      </div>
      <ul class="list-group mt-3" id="guesses"></ul>
    </div>
  </div>

  <script>
    let targetQID = "";
    let targetLabel = "";
    let gameReady = false;
    let loading = false;
    let selectedQID = null;
    let fetchController = null;
    let debounceTimeout;
    const apiKey = "453d3575-8f01-4d37-bbc9-973cffbe7429";
    const guesses = [];

    document.getElementById("guessInput").addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
        event.preventDefault();
        const suggestions = document.querySelectorAll("#autocompleteList .autocomplete-suggestion");
        if (suggestions.length > 0) {
        const first = suggestions[0];
        const match = first.innerText.match(/\((Q\d+)\)$/);
        if (match) {
            const qid = match[1];
            document.getElementById("guessInput").value = qid;
            selectedQID = qid;
            document.getElementById("autocompleteList").innerHTML = "";
        }
        }
        submitGuess();
    }
    });

    document.getElementById("guessInput").addEventListener("input", function () {
        clearTimeout(debounceTimeout);
        const query = this.value.trim();
        const list = document.getElementById("autocompleteList");

        // Don't fetch suggestions if input is empty
        if (query.length === 0) {
            list.innerHTML = "";
            return;
        }

        // Don't fetch suggestions for QIDs or queries with too many spaces
        if (/^Q\d+$/.test(query) || (query.match(/\s/g) || []).length >= 2) {
            list.innerHTML = "";
            return;
        }

        debounceTimeout = setTimeout(() => fetchSuggestions(query), 300);
    });

    async function fetchSuggestions(query) {
        if (fetchController) {
            fetchController.abort();
        }

        fetchController = new AbortController();

        try {
            // Fetch suggestions from Wikidata API
            const url = `https://www.wikidata.org/w/api.php?action=wbsearchentities&search=${encodeURIComponent(query)}&language=en&format=json&origin=*&limit=3`;
            const res = await fetch(url, { signal: fetchController.signal });
            const data = await res.json();

            const currentInput = document.getElementById("guessInput").value.trim();
            if (currentInput !== query) return;

            if (currentInput.length === 0) {
                document.getElementById("autocompleteList").innerHTML = "";
                return;
            }

            const list = document.getElementById("autocompleteList");
            list.innerHTML = "";
            selectedQID = null;
            data.search.forEach(entry => {
                const div = document.createElement("div");
                div.className = "autocomplete-suggestion";
                div.innerText = `${entry.label}, ${entry.description} (${entry.id})`;
                div.onclick = () => {
                    document.getElementById("guessInput").value = entry.id;
                    selectedQID = entry.id;
                    list.innerHTML = "";
                    submitGuess();
                };
                list.appendChild(div);
            });
        } catch (err) {
            if (err.name !== 'AbortError') {
            console.error("Suggestion fetch failed:", err);
            }
        }
    }

    async function getRandomItem() {
      try {
        // Fetch a random item from Wikidata that is part of "Vital articles/Level/4" and has a Wikipedia article
        const offset = Math.floor(Math.random() * 5000);
        const query = `
          SELECT ?item ?label WHERE {
            ?item wdt:P5008 wd:Q6173448 ;
                rdfs:label ?label ;
                schema:description ?desc .

            FILTER (LANG(?label) = "en")
            FILTER (LANG(?desc) = "en")
            FILTER (!CONTAINS(?label, " "))

            ?article schema:about ?item ;
                     schema:inLanguage "en" ;
                     schema:isPartOf <https://en.wikipedia.org/> .
          }
          OFFSET ${offset} LIMIT 1`;

        const url = `https://query.wikidata.org/sparql?query=` + encodeURIComponent(query)

        const response = await fetch(url, {
          headers: { 'Accept': 'application/sparql-results+json' }
        });

        if (!response.ok) throw new Error("Wikidata SPARQL query failed.");

        const json = await response.json();
        const qid = json.results.bindings[0].item.value.split('/').pop();
        const label = json.results.bindings[0].label.value;
        targetQID = qid;
        targetLabel = label;
        gameReady = true;

        document.getElementById("initialLoading").style.display = "none";
        document.getElementById("gameContent").style.display = "block";
      } catch (err) {
        alert("Failed to load target item: " + err.message);
      }
    }

    async function getSimilarityScoreQuery(text, qid) {
      // Get the similarity score from the Wikidata vector database.
      const params = new URLSearchParams({ query: text, qid });
      const response = await fetch(`https://wd-vectordb.toolforge.org/similarity-score?${params.toString()}`, {
        headers: { 'x-api-secret': apiKey }
      });

      if (!response.ok) throw new Error("Similarity API failed with status " + response.status);

      const json = await response.json();
      return json[0].similarity_score;
    }

    function getColor(score) {
      if (score <= 0.33) return "rgb(255, 0, 0, 0.5)";
      const ratio = Math.min((score - 0.33) / 0.33, 1);
      const red = Math.round(255 * (1 - ratio));
      const green = Math.round(255 * ratio);
      return `rgb(${red}, ${green}, 0, 0.5)`;
    }

    async function submitGuess() {
      if (!gameReady || loading) return;

      let input = document.getElementById("guessInput").value.trim();
      if (!input) return;

      // If the item is guessed, celebrate!
      if (input === targetQID) {
        const guessList = document.getElementById("guesses");
        const li = document.createElement("li");
        li.className = 'list-group-item correct';
        li.innerText = `${targetQID}: ${targetLabel} ðŸŽ‰ Correct! You found the target. ðŸŽ‰`;
        guessList.prepend(li);

        document.getElementById("guessInput").value = "";
        document.getElementById("autocompleteList").innerHTML = "";
        document.getElementById("guessBtn").disabled = true;
        document.getElementById("guessInput").disabled = true;
        return;
      }

      loading = true;
      document.getElementById("loadingSpinnerWrapper").style.display = "block";
      document.getElementById("guessBtn").disabled = true;
      document.getElementById("autocompleteList").innerHTML = "";

      let text = input;
      let score = 0;
      try{
        // If the input is a QID, fetch its label and description
        if (/^Q\d+$/.test(input)) {
          const qid = input
          const url = `https://www.wikidata.org/wiki/Special:EntityData/${qid}.json`;
          const res = await fetch(url);
          console.log(res);
          if (!res.ok) throw new Error("Failed to fetch entity info.");
          const data = await res.json();
          const entity = data.entities[input];
          const label = entity.labels?.en?.value || "";
          const description = entity.descriptions?.en?.value || "";
          input = `${input}: ${label}, <small>${description}</small>`;
          text = `${label}, ${description}`;
        }

        score = await getSimilarityScoreQuery(text, targetQID);

      } catch (err) {
        alert("No internet connection! Try again later.");
        return;
      }

      guesses.push({ input, score });
      guesses.sort((a, b) => b.score - a.score);

      const guessList = document.getElementById("guesses");
      guessList.innerHTML = "";
      guesses.forEach(guess => {
        const li = document.createElement("li");
        li.className = 'list-group-item';
        li.style.backgroundColor = getColor(guess.score);

        const left = document.createElement("span");
        left.innerHTML = guess.input;

        const right = document.createElement("span");
        right.className = "float-end";
        right.innerText = `Similarity: ${Math.floor(guess.score*100)}%`;

        li.appendChild(left);
        li.appendChild(right);

        guessList.appendChild(li);
      });

      document.getElementById("guessInput").value = "";
      document.getElementById("loadingSpinnerWrapper").style.display = "none";
      document.getElementById("guessBtn").disabled = false;
      loading = false;
    }

    getRandomItem();
  </script>
</body>
</html>
